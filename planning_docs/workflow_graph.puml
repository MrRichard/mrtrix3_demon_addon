@startuml Nipype Workflow Structure
!define ICONURL https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v2.4.0
!include ICONURL/common.puml
!include ICONURL/devicons2/python.puml

title MRtrix3 DWI Pipeline - Nipype Workflow Graph

package "Input Specification" {
    component [BIDS DWI Files] as input_dwi
    component [BIDS Anatomical] as input_anat
    component [FreeSurfer Data] as input_fs
    component [Fieldmaps (optional)] as input_fmap
}

package "Preprocessing Workflow" {
    component [mrconvert\nDWI to MIF] as mrconvert
    component [dwidenoise\nMP-PCA Denoising] as denoise
    component [mrdegibbs\nGibbs Removal] as degibbs
    component [dwifslpreproc\nDistortion + Eddy] as preproc
    component [dwibiascorrect\nN4 Bias Field] as biascorrect
    component [dwi2mask\nBrain Extraction] as mask
}

package "Response & FOD Estimation" {
    component [dwi2response\ntournier/dhollander] as response
    component [dwi2fod\ncsd/msmt_csd] as fod
    component [mtnormalise\nIntensity Norm] as normalize
}

package "Anatomical Registration" {
    component [5ttgen\nTissue Segmentation] as 5ttgen
    component [flirt\nCoregistration] as flirt
    component [mrtransform\nApply Transform] as mrtransform
    component [5tt2gmwmi\nGM-WM Interface] as gmwmi
}

package "Template Registration" {
    component [antsRegistration\nTemplate to Native] as ants_reg
    component [antsApplyTransforms\nAtlas to Native] as ants_apply
}

package "Tractography" {
    component [tckgen\n10M Streamlines] as tckgen
    component [tcksift\nSIFT Filtering] as sift
}

package "Connectome Generation" {
    component [tck2connectome\nBrainnetome] as connectome_bn
    component [tck2connectome\nFreeSurfer DK] as connectome_dk
    component [tck2connectome\nFreeSurfer Destrieux] as connectome_des
}

package "Output Generation" {
    component [Connectome CSV Files] as out_csv
    component [Tractography Files] as out_tck
    component [QC Report HTML] as out_qc
    component [Provenance JSON] as out_prov
}

' Data flow connections
input_dwi --> mrconvert
input_fmap --> preproc
mrconvert --> denoise
denoise --> degibbs : if single-shell
denoise --> preproc : if multi-shell
degibbs --> preproc
preproc --> biascorrect
biascorrect --> mask
biascorrect --> response
response --> fod
mask --> fod
fod --> normalize

input_anat --> 5ttgen
5ttgen --> flirt
mask --> flirt
flirt --> mrtransform
mrtransform --> gmwmi

normalize --> tckgen
gmwmi --> tckgen
mrtransform --> tckgen : 5tt_coreg
tckgen --> sift

mask --> ants_reg
ants_reg --> ants_apply
ants_apply --> connectome_bn

input_fs --> connectome_dk
input_fs --> connectome_des
sift --> connectome_bn
sift --> connectome_dk
sift --> connectome_des

connectome_bn --> out_csv
connectome_dk --> out_csv
connectome_des --> out_csv
sift --> out_tck
out_csv --> out_qc
out_tck --> out_qc
mrconvert --> out_prov

note right of preproc
  Conditional node based on
  distortion correction strategy:
  - rpe_pair (AP + PA DWI)
  - fieldmap (magnitude + phase)
  - none (rpe_none)
end note

note right of response
  Strategy-dependent:
  - Single-shell: tournier
  - Multi-shell: dhollander
end note

note right of fod
  Strategy-dependent:
  - Single-shell: csd
  - Multi-shell: msmt_csd
end note

note right of connectome_dk
  Conditional nodes:
  Only executed if
  FreeSurfer data available
end note

note left of degibbs
  Conditional node:
  Only for single-shell data
  (not recommended for multi-shell)
end note

@enduml
