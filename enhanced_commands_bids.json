{
  "pipeline_type": "bids_dwi_connectome",
  "description": "Unified MRtrix3 pipeline for BIDS-formatted DWI data with automatic distortion correction and shell detection",
  "version": "3.0",
  "required_inputs": {
    "DWI_AP": "Primary DWI data (dir-AP) in NIFTI format",
    "DWI_AP_BVEC": "B-vectors file for primary DWI",
    "DWI_AP_BVAL": "B-values file for primary DWI",
    "DWI_PA": "Secondary DWI data (dir-PA) for rpe_pair distortion correction (optional)",
    "DWI_PA_BVEC": "B-vectors file for secondary DWI (optional)",
    "DWI_PA_BVAL": "B-values file for secondary DWI (optional)",
    "ANAT": "T1w anatomical reference image",
    "TEMPLATE": "MNI template directory",
    "FIELDMAP_MAG1": "First magnitude image for fieldmap correction (optional)",
    "FIELDMAP_MAG2": "Second magnitude image for fieldmap correction (optional)",
    "FIELDMAP_PHASEDIFF": "Phase difference image for fieldmap correction (optional)",
    "DELTA_TE": "Echo time difference in milliseconds for fieldmap (optional)",
    "PE_DIR": "Phase encoding direction (e.g., j, j-, i, i-)",
    "READOUTTIME": "Total EPI readout time in seconds",
    "OUTPUT": "Output directory path"
  },
  "steps": [
    {
      "name": "step1a-mrconvert_dwi_ap",
      "cmd": "mrconvert DWI_AP OUTPUT/dwi_ap.mif -fslgrad DWI_AP_BVEC DWI_AP_BVAL -force",
      "validation_output": "OUTPUT/dwi_ap.mif",
      "description": "Convert primary DWI (dir-AP) to MIF format with gradient information"
    },
    {
      "name": "step1b-mrconvert_dwi_pa",
      "cmd": "mrconvert DWI_PA OUTPUT/dwi_pa.mif -fslgrad DWI_PA_BVEC DWI_PA_BVAL -force",
      "validation_output": "OUTPUT/dwi_pa.mif",
      "description": "Convert secondary DWI (dir-PA) to MIF format",
      "distortion_correction": "rpe_pair"
    },
    {
      "name": "step2a-dwiextract_ap_b0",
      "cmd": "dwiextract OUTPUT/dwi_ap.mif OUTPUT/dwi_ap_b0s.mif -bzero -force",
      "validation_output": "OUTPUT/dwi_ap_b0s.mif",
      "description": "Extract b=0 images from primary DWI"
    },
    {
      "name": "step2b-mrconvert_ap_b0_first",
      "cmd": "mrconvert OUTPUT/dwi_ap_b0s.mif -coord 3 0 OUTPUT/dwi_ap_b0.mif -force",
      "validation_output": "OUTPUT/dwi_ap_b0.mif",
      "description": "Extract first b=0 from primary DWI for b0 pair"
    },
    {
      "name": "step2c-mrconvert_pa_b0",
      "cmd": "mrconvert OUTPUT/dwi_pa.mif OUTPUT/dwi_pa_b0.mif -force",
      "validation_output": "OUTPUT/dwi_pa_b0.mif",
      "description": "Convert secondary DWI to b0 for pairing",
      "distortion_correction": "rpe_pair"
    },
    {
      "name": "step2d-mrcat_b0_pair",
      "cmd": "mrcat OUTPUT/dwi_ap_b0.mif OUTPUT/dwi_pa_b0.mif OUTPUT/b0_pair.mif -axis 3",
      "validation_output": "OUTPUT/b0_pair.mif",
      "description": "Concatenate AP and PA b0s for distortion correction",
      "distortion_correction": "rpe_pair"
    },
    {
      "name": "step3-dwidenoise",
      "cmd": "dwidenoise OUTPUT/dwi_ap.mif OUTPUT/dwi_den.mif -noise OUTPUT/noise.mif -force -nthreads 8",
      "validation_output": "OUTPUT/dwi_den.mif",
      "description": "MP-PCA denoising of DWI data"
    },
    {
      "name": "step4-mrcalc_residual",
      "cmd": "mrcalc OUTPUT/dwi_ap.mif OUTPUT/dwi_den.mif -subtract OUTPUT/residual.mif -force",
      "validation_output": "OUTPUT/residual.mif",
      "description": "Calculate denoising residual for QC"
    },
    {
      "name": "step5-mrdegibbs",
      "cmd": "mrdegibbs OUTPUT/dwi_den.mif OUTPUT/dwi_den_degibbs.mif -force",
      "validation_output": "OUTPUT/dwi_den_degibbs.mif",
      "description": "Remove Gibbs ringing artifacts",
      "shell_config": "single_shell"
    },
    {
      "name": "step6a-fieldmap_mag_convert",
      "cmd": "mrconvert FIELDMAP_MAG2 OUTPUT/fieldmap_mag.mif -force",
      "validation_output": "OUTPUT/fieldmap_mag.mif",
      "description": "Convert magnitude image to MIF format",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step6b-fieldmap_phase_convert",
      "cmd": "mrconvert FIELDMAP_PHASEDIFF OUTPUT/fieldmap_phase.mif -force",
      "validation_output": "OUTPUT/fieldmap_phase.mif",
      "description": "Convert phase difference image to MIF format",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step6c-fieldmap_mag_nifti",
      "cmd": "mrconvert OUTPUT/fieldmap_mag.mif OUTPUT/fieldmap_mag.nii.gz -force",
      "validation_output": "OUTPUT/fieldmap_mag.nii.gz",
      "description": "Convert magnitude to NIFTI for FSL",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step6d-fieldmap_brain_extract",
      "cmd": "bet2 OUTPUT/fieldmap_mag.nii.gz OUTPUT/fieldmap_mag_brain.nii.gz -f 0.5 -m",
      "validation_output": "OUTPUT/fieldmap_mag_brain.nii.gz",
      "description": "Brain extract the magnitude image",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step6e-fieldmap_phase_nifti",
      "cmd": "mrconvert OUTPUT/fieldmap_phase.mif OUTPUT/fieldmap_phase.nii.gz -force",
      "validation_output": "OUTPUT/fieldmap_phase.nii.gz",
      "description": "Convert phase to NIFTI for FSL",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step6f-fieldmap_prepare",
      "cmd": "fsl_prepare_fieldmap SIEMENS OUTPUT/fieldmap_phase.nii.gz OUTPUT/fieldmap_mag_brain.nii.gz OUTPUT/fieldmap_rads.nii.gz DELTA_TE",
      "validation_output": "OUTPUT/fieldmap_rads.nii.gz",
      "description": "Prepare fieldmap in radians",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step6g-create_acqparams",
      "cmd": "echo '0 1 0 READOUTTIME' > OUTPUT/acqparams.txt",
      "validation_output": "OUTPUT/acqparams.txt",
      "description": "Create acquisition parameters file",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step6h-fieldmap_to_hz",
      "cmd": "fslmaths OUTPUT/fieldmap_rads.nii.gz -div 6.28318530718 OUTPUT/fieldmap_hz.nii.gz",
      "validation_output": "OUTPUT/fieldmap_hz.nii.gz",
      "description": "Convert fieldmap from radians to Hz",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step7a-dwifslpreproc_rpe_pair",
      "cmd": "dwifslpreproc OUTPUT/dwi_den.mif OUTPUT/dwi_den_preproc.mif -pe_dir PE_DIR -rpe_pair -se_epi OUTPUT/b0_pair.mif -eddy_options \"--slm=linear --data_is_shelled\" -force -nthreads 8 -readout_time READOUTTIME",
      "validation_output": "OUTPUT/dwi_den_preproc.mif",
      "description": "FSL preprocessing with reverse phase-encode pair distortion correction",
      "distortion_correction": "rpe_pair",
      "shell_config": "multi_shell"
    },
    {
      "name": "step7a-dwifslpreproc_rpe_pair_ss",
      "cmd": "dwifslpreproc OUTPUT/dwi_den_degibbs.mif OUTPUT/dwi_den_preproc.mif -pe_dir PE_DIR -rpe_pair -se_epi OUTPUT/b0_pair.mif -eddy_options \"--slm=linear --data_is_shelled\" -force -nthreads 8 -readout_time READOUTTIME",
      "validation_output": "OUTPUT/dwi_den_preproc.mif",
      "description": "FSL preprocessing with reverse phase-encode pair (single-shell, includes degibbs)",
      "distortion_correction": "rpe_pair",
      "shell_config": "single_shell"
    },
    {
      "name": "step7b-dwifslpreproc_fieldmap",
      "cmd": "dwifslpreproc OUTPUT/dwi_den_degibbs.mif OUTPUT/dwi_den_preproc.mif -rpe_none -pe_dir PE_DIR -eddy_options \"--slm=linear --data_is_shelled\" -topup_options \"--fmap=OUTPUT/fieldmap_rads.nii.gz --datain=OUTPUT/acqparams.txt --field=OUTPUT/fieldmap_hz\" -force -nthreads 8 -readout_time READOUTTIME",
      "validation_output": "OUTPUT/dwi_den_preproc.mif",
      "description": "FSL preprocessing with fieldmap-based distortion correction",
      "distortion_correction": "fieldmap"
    },
    {
      "name": "step7c-dwifslpreproc_none",
      "cmd": "dwifslpreproc OUTPUT/dwi_den_degibbs.mif OUTPUT/dwi_den_preproc.mif -rpe_none -pe_dir PE_DIR -eddy_options \"--slm=linear --data_is_shelled\" -force -nthreads 8 -readout_time READOUTTIME",
      "validation_output": "OUTPUT/dwi_den_preproc.mif",
      "description": "FSL preprocessing without distortion correction (single-shell)",
      "distortion_correction": "none",
      "shell_config": "single_shell"
    },
    {
      "name": "step7c-dwifslpreproc_none_ms",
      "cmd": "dwifslpreproc OUTPUT/dwi_den.mif OUTPUT/dwi_den_preproc.mif -rpe_none -pe_dir PE_DIR -eddy_options \"--slm=linear --data_is_shelled\" -force -nthreads 8 -readout_time READOUTTIME",
      "validation_output": "OUTPUT/dwi_den_preproc.mif",
      "description": "FSL preprocessing without distortion correction (multi-shell)",
      "distortion_correction": "none",
      "shell_config": "multi_shell"
    },
    {
      "name": "step8-dwibiascorrect",
      "cmd": "dwibiascorrect ants OUTPUT/dwi_den_preproc.mif OUTPUT/dwi_den_preproc_unbiased.mif -bias OUTPUT/bias.mif -force",
      "validation_output": "OUTPUT/dwi_den_preproc_unbiased.mif",
      "description": "ANTs N4 bias field correction"
    },
    {
      "name": "step9-dwi2mask",
      "cmd": "dwi2mask OUTPUT/dwi_den_preproc_unbiased.mif OUTPUT/mask.mif -force",
      "validation_output": "OUTPUT/mask.mif",
      "description": "Generate brain mask from DWI data",
      "conditional": "skip_if_external_mask"
    },
    {
      "name": "step10a-dwi2response_dhollander",
      "cmd": "dwi2response dhollander OUTPUT/dwi_den_preproc_unbiased.mif OUTPUT/wm_response.txt OUTPUT/gm_response.txt OUTPUT/csf_response.txt -voxels OUTPUT/voxels_response.mif -force",
      "validation_output": "OUTPUT/voxels_response.mif",
      "description": "Dhollander response function estimation (multi-shell)",
      "shell_config": "multi_shell"
    },
    {
      "name": "step10b-dwi2response_tournier",
      "cmd": "dwi2response tournier OUTPUT/dwi_den_preproc_unbiased.mif OUTPUT/wm_response.txt -mask OUTPUT/mask.mif -voxels OUTPUT/voxels_response.mif -force",
      "validation_output": "OUTPUT/voxels_response.mif",
      "description": "Tournier response function estimation (single-shell)",
      "shell_config": "single_shell"
    },
    {
      "name": "step11a-dwi2fod_msmt_csd",
      "cmd": "dwi2fod msmt_csd -mask OUTPUT/mask.mif OUTPUT/dwi_den_preproc_unbiased.mif OUTPUT/wm_response.txt OUTPUT/wmfod.mif OUTPUT/gm_response.txt OUTPUT/gmfod.mif OUTPUT/csf_response.txt OUTPUT/csffod.mif -force",
      "validation_output": "OUTPUT/wmfod.mif",
      "description": "Multi-shell multi-tissue CSD FOD estimation",
      "shell_config": "multi_shell"
    },
    {
      "name": "step11b-dwi2fod_csd",
      "cmd": "dwi2fod csd -mask OUTPUT/mask.mif OUTPUT/dwi_den_preproc_unbiased.mif OUTPUT/wm_response.txt OUTPUT/wmfod.mif -force",
      "validation_output": "OUTPUT/wmfod.mif",
      "description": "Single-shell CSD FOD estimation",
      "shell_config": "single_shell"
    },
    {
      "name": "step12a-mtnormalise_multi",
      "cmd": "mtnormalise OUTPUT/wmfod.mif OUTPUT/wmfod_norm.mif OUTPUT/gmfod.mif OUTPUT/gmfod_norm.mif OUTPUT/csffod.mif OUTPUT/csffod_norm.mif -mask OUTPUT/mask.mif -debug -force",
      "validation_output": "OUTPUT/wmfod_norm.mif",
      "description": "Multi-tissue FOD intensity normalization",
      "shell_config": "multi_shell"
    },
    {
      "name": "step12b-mtnormalise_single",
      "cmd": "mtnormalise OUTPUT/wmfod.mif OUTPUT/wmfod_norm.mif -mask OUTPUT/mask.mif -debug -force",
      "validation_output": "OUTPUT/wmfod_norm.mif",
      "description": "Single-tissue FOD intensity normalization",
      "shell_config": "single_shell"
    },
    {
      "name": "step13-anat_convert",
      "cmd": "mrconvert ANAT OUTPUT/anat.mif -force",
      "validation_output": "OUTPUT/anat.mif",
      "description": "Convert anatomical image to MIF format"
    },
    {
      "name": "step14-5ttgen",
      "cmd": "5ttgen fsl OUTPUT/anat.mif OUTPUT/5tt_nocoreg.mif",
      "validation_output": "OUTPUT/5tt_nocoreg.mif",
      "description": "Generate 5-tissue-type segmentation"
    },
    {
      "name": "step15-dwiextract_b0",
      "cmd": "dwiextract OUTPUT/dwi_den_preproc_unbiased.mif OUTPUT/dwi_den_preproc_b0.mif -bzero",
      "validation_output": "OUTPUT/dwi_den_preproc_b0.mif",
      "description": "Extract b=0 from preprocessed data"
    },
    {
      "name": "step16-mrmath_mean_b0",
      "cmd": "mrmath OUTPUT/dwi_den_preproc_b0.mif mean OUTPUT/mean_b0_processed.mif -axis 3",
      "validation_output": "OUTPUT/mean_b0_processed.mif",
      "description": "Calculate mean b=0 from preprocessed data"
    },
    {
      "name": "step17-mrconvert_b0_nifti",
      "cmd": "mrconvert OUTPUT/mean_b0_processed.mif OUTPUT/mean_b0_processed.nii.gz",
      "validation_output": "OUTPUT/mean_b0_processed.nii.gz",
      "description": "Convert mean b=0 to NIFTI for FSL registration"
    },
    {
      "name": "step18-mrconvert_5tt_nifti",
      "cmd": "mrconvert OUTPUT/5tt_nocoreg.mif OUTPUT/5tt_nocoreg.nii.gz",
      "validation_output": "OUTPUT/5tt_nocoreg.nii.gz",
      "description": "Convert 5TT segmentation to NIFTI"
    },
    {
      "name": "step19-fslroi_gm",
      "cmd": "fslroi OUTPUT/5tt_nocoreg.nii.gz OUTPUT/5tt_vol0.nii.gz 0 1",
      "validation_output": "OUTPUT/5tt_vol0.nii.gz",
      "description": "Extract first volume (GM) from 5TT segmentation"
    },
    {
      "name": "step20-flirt_coregister",
      "cmd": "flirt -in OUTPUT/mean_b0_processed.nii.gz -ref OUTPUT/5tt_vol0.nii.gz -interp nearestneighbour -dof 6 -omat OUTPUT/diff2struct_fsl.mat",
      "validation_output": "OUTPUT/diff2struct_fsl.mat",
      "description": "Coregister diffusion to structural (6 DOF)"
    },
    {
      "name": "step21-transformconvert",
      "cmd": "transformconvert OUTPUT/diff2struct_fsl.mat OUTPUT/mean_b0_processed.nii.gz OUTPUT/5tt_nocoreg.nii.gz flirt_import OUTPUT/diff2struct_mrtrix.txt",
      "validation_output": "OUTPUT/diff2struct_mrtrix.txt",
      "description": "Convert FSL transformation to MRtrix format"
    },
    {
      "name": "step22-mrtransform_5tt",
      "cmd": "mrtransform OUTPUT/5tt_nocoreg.mif -linear OUTPUT/diff2struct_mrtrix.txt -inverse OUTPUT/5tt_coreg.mif",
      "validation_output": "OUTPUT/5tt_coreg.mif",
      "description": "Apply transformation to bring 5TT to diffusion space"
    },
    {
      "name": "step23-5tt2gmwmi",
      "cmd": "5tt2gmwmi OUTPUT/5tt_coreg.mif OUTPUT/gmwmSeed_coreg.mif",
      "validation_output": "OUTPUT/gmwmSeed_coreg.mif",
      "description": "Generate GM-WM interface for seeding"
    },
    {
      "name": "step24a-tckgen_multi",
      "cmd": "tckgen -act OUTPUT/5tt_coreg.mif -backtrack -seed_gmwmi OUTPUT/gmwmSeed_coreg.mif -nthreads 8 -maxlength 250 -cutoff 0.06 -select 10000000 OUTPUT/wmfod_norm.mif OUTPUT/tracks_10M.tck",
      "validation_output": "OUTPUT/tracks_10M.tck",
      "description": "Generate 10M streamlines (multi-shell, lower cutoff)",
      "shell_config": "multi_shell"
    },
    {
      "name": "step24b-tckgen_single",
      "cmd": "tckgen -act OUTPUT/5tt_coreg.mif -backtrack -seed_gmwmi OUTPUT/gmwmSeed_coreg.mif -nthreads 8 -maxlength 250 -cutoff 0.1 -select 10000000 OUTPUT/wmfod_norm.mif OUTPUT/tracks_10M.tck",
      "validation_output": "OUTPUT/tracks_10M.tck",
      "description": "Generate 10M streamlines (single-shell, higher cutoff)",
      "shell_config": "single_shell"
    },
    {
      "name": "step25-tckedit",
      "cmd": "tckedit OUTPUT/tracks_10M.tck -number 200k OUTPUT/smallerTracks_200k.tck",
      "validation_output": "OUTPUT/smallerTracks_200k.tck",
      "description": "Create subset of 200k tracks for visualization"
    },
    {
      "name": "step26-tcksift",
      "cmd": "tcksift -fd_scale_gm -act OUTPUT/5tt_coreg.mif -term_number 1000000 OUTPUT/tracks_10M.tck OUTPUT/wmfod_norm.mif OUTPUT/sift_1M.tck",
      "validation_output": "OUTPUT/sift_1M.tck",
      "description": "SIFT filtering to 1M biologically plausible streamlines"
    },
    {
      "name": "step27-convert_mask_nifti",
      "cmd": "mrconvert OUTPUT/mask.mif OUTPUT/mask.nii.gz",
      "validation_output": "OUTPUT/mask.nii.gz",
      "description": "Convert mask to NIFTI format"
    },
    {
      "name": "step28-apply_mask",
      "cmd": "fslmaths OUTPUT/mean_b0_processed.nii.gz -mas OUTPUT/mask.nii.gz OUTPUT/mean_b0_brain.nii.gz",
      "validation_output": "OUTPUT/mean_b0_brain.nii.gz",
      "description": "Apply brain mask to mean b=0 image"
    },
    {
      "name": "step29-antsReg_template",
      "cmd": "/opt/ants/antsRegistrationSyN.sh -d 3 -m TEMPLATE/mni_icbm152_nlin_sym_09a/mni_icbm152_t2_relx_tal_nlin_sym_09a.nii -f OUTPUT/mean_b0_brain.nii.gz -o OUTPUT/dwi_MNI_to_native_ -n 8",
      "validation_output": "OUTPUT/dwi_MNI_to_native_Warped.nii.gz",
      "description": "Register MNI template to native space using ANTs"
    },
    {
      "name": "step30-brainnetome_transform",
      "cmd": "/opt/ants/antsApplyTransforms -d 3 -i TEMPLATE/mni_icbm152_nlin_sym_09a/Brainnetome.nii.gz -r OUTPUT/mean_b0_brain.nii.gz -o OUTPUT/dwi_Brainnetome.nii.gz -t OUTPUT/dwi_MNI_to_native_1Warp.nii.gz -t OUTPUT/dwi_MNI_to_native_0GenericAffine.mat -v -n nearestneighbor",
      "validation_output": "OUTPUT/dwi_Brainnetome.nii.gz",
      "description": "Transform Brainnetome atlas to native diffusion space"
    },
    {
      "name": "step31-freesurfer_labelconvert_DK",
      "cmd": "labelconvert FS_APARC_ASEG $FREESURFER_HOME/FreeSurferColorLUT.txt $MRTRIX3_DIR/share/mrtrix3/labelconvert/fs_default.txt OUTPUT/nodes_freesurfer_DK.mif",
      "validation_output": "OUTPUT/nodes_freesurfer_DK.mif",
      "species": "human",
      "requires": "FS_APARC_ASEG",
      "description": "Convert FreeSurfer DK atlas to MRtrix format"
    },
    {
      "name": "step32-freesurfer_labelsgmfix_DK",
      "cmd": "labelsgmfix OUTPUT/nodes_freesurfer_DK.mif FS_BRAIN $MRTRIX3_DIR/share/mrtrix3/labelconvert/fs_default.txt OUTPUT/nodes_freesurfer_DK_fixed.mif -premasked",
      "validation_output": "OUTPUT/nodes_freesurfer_DK_fixed.mif",
      "species": "human",
      "requires": "FS_APARC_ASEG",
      "description": "Fix FreeSurfer segmentation issues"
    },
    {
      "name": "step33-freesurfer_transform_DK",
      "cmd": "mrtransform OUTPUT/nodes_freesurfer_DK_fixed.mif -linear OUTPUT/diff2struct_mrtrix.txt -inverse OUTPUT/nodes_freesurfer_DK_dwi.mif",
      "validation_output": "OUTPUT/nodes_freesurfer_DK_dwi.mif",
      "species": "human",
      "requires": "FS_APARC_ASEG",
      "description": "Transform FreeSurfer DK atlas to diffusion space"
    },
    {
      "name": "step34-freesurfer_labelconvert_Destrieux",
      "cmd": "labelconvert FS_APARC_DESTRIEUX $FREESURFER_HOME/FreeSurferColorLUT.txt $MRTRIX3_DIR/share/mrtrix3/labelconvert/fs_a2009s.txt OUTPUT/nodes_freesurfer_Destrieux.mif",
      "validation_output": "OUTPUT/nodes_freesurfer_Destrieux.mif",
      "species": "human",
      "requires": "FS_APARC_DESTRIEUX",
      "description": "Convert FreeSurfer Destrieux atlas to MRtrix format"
    },
    {
      "name": "step35-freesurfer_transform_Destrieux",
      "cmd": "mrtransform OUTPUT/nodes_freesurfer_Destrieux.mif -linear OUTPUT/diff2struct_mrtrix.txt -inverse OUTPUT/nodes_freesurfer_Destrieux_dwi.mif",
      "validation_output": "OUTPUT/nodes_freesurfer_Destrieux_dwi.mif",
      "species": "human",
      "requires": "FS_APARC_DESTRIEUX",
      "description": "Transform FreeSurfer Destrieux atlas to diffusion space"
    },
    {
      "name": "step36-connectome_brainnetome_counts",
      "cmd": "tck2connectome -symmetric -zero_diagonal OUTPUT/sift_1M.tck OUTPUT/dwi_Brainnetome.nii.gz OUTPUT/connectome_Brainnetome_counts.csv -out_assignments OUTPUT/assignments_Brainnetome_counts.csv",
      "validation_output": "OUTPUT/connectome_Brainnetome_counts.csv",
      "description": "Generate Brainnetome connectome (streamline counts)"
    },
    {
      "name": "step37-connectome_brainnetome_scaled",
      "cmd": "tck2connectome -symmetric -zero_diagonal -scale_invnodevol OUTPUT/sift_1M.tck OUTPUT/dwi_Brainnetome.nii.gz OUTPUT/connectome_Brainnetome_scaled.csv -out_assignments OUTPUT/assignments_Brainnetome_scaled.csv",
      "validation_output": "OUTPUT/connectome_Brainnetome_scaled.csv",
      "description": "Generate Brainnetome connectome (volume-normalized)"
    },
    {
      "name": "step38-connectome_FreeSurfer_DK_counts",
      "cmd": "tck2connectome -symmetric -zero_diagonal OUTPUT/sift_1M.tck OUTPUT/nodes_freesurfer_DK_dwi.mif OUTPUT/connectome_FreeSurfer_DK_counts.csv -out_assignments OUTPUT/assignments_FreeSurfer_DK_counts.csv",
      "validation_output": "OUTPUT/connectome_FreeSurfer_DK_counts.csv",
      "species": "human",
      "requires": "FS_APARC_ASEG",
      "description": "Generate FreeSurfer DK connectome (streamline counts)"
    },
    {
      "name": "step39-connectome_FreeSurfer_DK_scaled",
      "cmd": "tck2connectome -symmetric -zero_diagonal -scale_invnodevol OUTPUT/sift_1M.tck OUTPUT/nodes_freesurfer_DK_dwi.mif OUTPUT/connectome_FreeSurfer_DK_scaled.csv -out_assignments OUTPUT/assignments_FreeSurfer_DK_scaled.csv",
      "validation_output": "OUTPUT/connectome_FreeSurfer_DK_scaled.csv",
      "species": "human",
      "requires": "FS_APARC_ASEG",
      "description": "Generate FreeSurfer DK connectome (volume-normalized)"
    },
    {
      "name": "step40-connectome_FreeSurfer_Destrieux_counts",
      "cmd": "tck2connectome -symmetric -zero_diagonal OUTPUT/sift_1M.tck OUTPUT/nodes_freesurfer_Destrieux_dwi.mif OUTPUT/connectome_FreeSurfer_Destrieux_counts.csv -out_assignments OUTPUT/assignments_FreeSurfer_Destrieux_counts.csv",
      "validation_output": "OUTPUT/connectome_FreeSurfer_Destrieux_counts.csv",
      "species": "human",
      "requires": "FS_APARC_DESTRIEUX",
      "description": "Generate FreeSurfer Destrieux connectome (streamline counts)"
    },
    {
      "name": "step41-connectome_FreeSurfer_Destrieux_scaled",
      "cmd": "tck2connectome -symmetric -zero_diagonal -scale_invnodevol OUTPUT/sift_1M.tck OUTPUT/nodes_freesurfer_Destrieux_dwi.mif OUTPUT/connectome_FreeSurfer_Destrieux_scaled.csv -out_assignments OUTPUT/assignments_FreeSurfer_Destrieux_scaled.csv",
      "validation_output": "OUTPUT/connectome_FreeSurfer_Destrieux_scaled.csv",
      "species": "human",
      "requires": "FS_APARC_DESTRIEUX",
      "description": "Generate FreeSurfer Destrieux connectome (volume-normalized)"
    }
  ],
  "distortion_correction_strategies": {
    "rpe_pair": "Both dir-AP and dir-PA DWI exist - use -rpe_pair with b0_pair.mif",
    "fieldmap": "Single DWI + fieldmap files exist - use fieldmap-based correction",
    "none": "No reverse PE or fieldmaps - use -rpe_none, skip distortion correction"
  },
  "shell_configuration": {
    "multi_shell": "2+ non-zero b-values detected - use dhollander response, msmt_csd FOD",
    "single_shell": "1 non-zero b-value detected - use tournier response, csd FOD, apply mrdegibbs"
  },
  "pipeline_notes": {
    "step_filtering": "Steps are filtered by species, requires, distortion_correction, and shell_config fields",
    "freesurfer_integration": "FreeSurfer atlases are only used if derivatives/freesurfer*/sub-XX/ exists",
    "external_mask": "If --mask is provided, step9-dwi2mask is skipped and the external mask is used"
  }
}
